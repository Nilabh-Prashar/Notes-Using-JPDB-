<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script src="http://login2explore.com/jpdb/resources/js/0.0.3/jpdb-commons.js"></script>
    <script src="script.js"></script>
    <title>Hello, world!</title>
</head>

<body>
    <!-- modal starts -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit this Note</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <form action="#" method="POST">
                        <input type="hidden" name="snoEdit" id="snoEdit">
                        <div class="mb-3">
                            <label for="edittitle" class="form-label">Note Title</label>
                            <input type="text" class="form-control" id="titleEdit" name="titleEdit"
                                aria-describedby="emailHelp">
                        </div>
                        <div class="mb-3">
                            <textarea class="form-control" placeholder="Note Description" name="descriptionEdit"
                                id="descEdit" style="height: 100px"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary"  id="closeModal" data-bs-dismiss="modal">Close</button>
                            <button type="button" onclick="insertUpdate(this.id)" id=""
                                class="btn editBtn btn-primary">Save
                                changes</button>
                        </div>

                    </form>
                </div>

            </div>
        </div>
    </div>
    <!-- modal ends -->
    <!-- navbar start -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">iNotes</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Service</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a>
                    </li>
                </ul>
                <form class="d-flex">
                    <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
                    <button class="btn btn-outline-success" type="submit">Search</button>
                </form>
            </div>
        </div>
    </nav>
    <!-- navbar ends -->
    <div class="container mt-4">
        <h2>Add a Note</h2>
        <!-- form start -->
        <form action="#" method="POST">
            <div class="mb-3">
                <label for="title" class="form-label">Note Title</label>
                <input type="text" class="form-control" id="title" name="title" aria-describedby="emailHelp">
            </div>
            <div class="mb-3">
                <textarea class="form-control" placeholder="Note Description" name="desc" id="desc"
                    style="height: 100px"></textarea>
            </div>

            <button type="button" onclick="insert()" id="insertButton" class="btn btn-primary">Add Note</button>

        </form>
        <!-- form ends -->
        <!-- table starts -->
        <div class="container my-4">
            <table class="table" id="myTable">
                <thead>
                    <tr>
                        <th scope="col">S.No</th>
                        <th scope="col">Title</th>
                        <th scope="col">Notes</th>
                        <th scope="col">Action</th>
                    </tr>
                </thead>
                <tbody id="tbody">

                </tbody>
            </table>
        </div>
        <!-- table ends -->
        <hr>

    </div>

    <!-- Optional JavaScript; choose one of the two! -->

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
        crossorigin="anonymous"></script>
    <script>
        $(document).ready(function () {
            $('#myTable').DataTable();
        })
    </script>
    <script>
        var token = "90935623|-31948840173584499|90933324";
        var dbName = "Employee";
        var relName = "iNotes";

        showAll();
        function insert(params) {

            var title = document.getElementById("title").value;
            var desc = document.getElementById("desc").value;
            console.log(title);
            console.log(desc);
            var jsonObj = {
                "tittle": title,
                "description": desc
            };
            let jsonStr = JSON.stringify(jsonObj);
            let reqStr = createPUTRequest(token, jsonStr, dbName, relName);
            jQuery.ajaxSetup({ async: false });
            let resultObj = executeCommand(reqStr, "http://api.login2explore.com:5577", "/api/iml")
            jQuery.ajaxSetup({ async: true });
            var resultStr = JSON.stringify(resultObj);
            // alert(resultStr);
            showAll();
        }
        function update(up_id) {
            console.log(up_id);
            let upId = up_id.slice(2);
            console.log(upId);
            var abcElement = document.querySelector('.editBtn');
            abcElement.id = upId;
            let getAllReqStr = getByRecord(token, dbName, relName, upId);
            console.log(getAllReqStr);
            jQuery.ajaxSetup({ async: false });
            let resultObj = executeCommand(getAllReqStr, "http://api.login2explore.com:5577", "/api/irl")
            jQuery.ajaxSetup({ async: true });
            let ab = JSON.parse(resultObj.data);
            console.log(ab.record.tittle);
            console.log(ab.record.description);
            document.getElementById("titleEdit").value = ab.record.tittle;
            document.getElementById("descEdit").value = ab.record.description;
        }
        function insertUpdate(updateId) {
            let titleEdit = document.getElementById("titleEdit").value;
            let descEdit = document.getElementById("descEdit").value;
            var uId = updateId;
            console.log(uId);
            jsonObj = {
                "tittle": titleEdit,
                "description": descEdit
            }
            console.log(jsonObj);
            var jsonStr = JSON.stringify(jsonObj);
            console.log(jsonStr)
            var upDateStr = createUPDATERecordRequest(token, jsonStr, dbName, relName, updateId);
            console.log(upDateStr);
            jQuery.ajaxSetup({ async: false });
            let resultObj = executeCommand(upDateStr, "http://api.login2explore.com:5577", "/api/iml")
            jQuery.ajaxSetup({ async: true });
            showAll();
            document.getElementById("closeModal").click();
        }
        function remove(del_id) {

            let del = del_id.slice(3);
            console.log(del_id);
            console.log(del);
            let removeStr = createREMOVERecordRequest(token, dbName, relName, del);
            jQuery.ajaxSetup({ async: false });
            let resultObj = executeCommand(removeStr, "http://api.login2explore.com:5577", "/api/iml")
            jQuery.ajaxSetup({ async: true });
            showAll();
        }
        function showAll() {

            let pageNo = 1;
            let pageSize = 100;
            let getAllReqStr = createGETALLRecordRequest(token, dbName, relName, pageNo, pageSize);
            // console.log(getAllReqStr);
            jQuery.ajaxSetup({ async: false });
            let resultObj = executeCommand(getAllReqStr, "http://api.login2explore.com:5577", "/api/irl")
            jQuery.ajaxSetup({ async: true });
            let ab = JSON.parse(resultObj.data);


            var html = "";

            // console.log(ab.json_records);
            // console.log(ab.json_records[1].record);
            // console.log(ab.json_records[1].record.description);
            // console.log(ab.json_records[1].rec_no);
            var chkIndex;
            for (chkIndex = 0; chkIndex < ab.json_records.length; chkIndex++) {
                if (ab.json_records[chkIndex].record != null)
                    break;
            }
            console.log(chkIndex);
            var index;
            for (index = chkIndex; index < ab.json_records.length; index++) {
                if (ab.json_records[index].record == null) { continue; }
                html += "<tr>";
                html += "<th scope=\"row\">" + ab.json_records[index].rec_no;
                html += "</th>";
                html += "<td>" + ab.json_records[index].record.tittle + "</td>";
                html += "<td>" + ab.json_records[index].record.description + "</td>";
                html += "<td> <button class='edit btn btn-sm btn-primary' data-bs-toggle=\"modal\" data-bs-target=\"#editModal\" onclick=\"update(this.id)\" id=\"up" + ab.json_records[index].rec_no + "\">Edit</button>"

                    + "  <button class='delete btn btn-sm btn-primary' onclick=\"remove(this.id)\" id=\"del" + ab.json_records[index].rec_no + "\">Delete</button> </td>";
                html += "</tr>";
            }
            document.getElementById("tbody").innerHTML = html;
            console.log(index);
            let resultStr = JSON.stringify(ab.json_records);
            // console.log(html);
        }
        function executeCommand(reqString, dbBaseUrl, apiEndPointUrl) {
            var url = dbBaseUrl + apiEndPointUrl;
            var jsonObj;
            $.post(url, reqString, function (result) {
                jsonObj = JSON.parse(result);
            }).fail(function (result) {
                var dataJsonObj = result.responseText;
                jsonObj = JSON.parse(dataJsonObj);
            });
            return jsonObj;
        }
        function getByRecord(token, dbName, relName, record) {
            var req = "{\n"
                + "\"token\" : \""
                + token
                + "\","
                + "\"dbName\": \""
                + dbName
                + "\",\n" + "\"cmd\" : \"GET_BY_RECORD\"\n"
                + "\"rel\" : \""
                + relName
                + "\",\n"
                + "\"record\": \""
                + record +"\""
                + "}";
            return req;
        }

    </script>


    <!-- Option 2: Separate Popper and Bootstrap JS -->
    <!--
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.min.js" integrity="sha384-Atwg2Pkwv9vp0ygtn1JAojH0nYbwNJLPhwyoVbhoPwBhjQPR5VtM2+xf0Uwh9KtT" crossorigin="anonymous"></script>
    -->
</body>

</html>